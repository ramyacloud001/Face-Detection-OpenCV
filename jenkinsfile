pipeline {
  agent any

  stages {
    stage('Build') {
      steps {
        git clone "https://github.com/ramyacloud001/Face-Detection-OpenCV.git"

        sh 'docker build -t python-app-image:latest .'
      }
    }

    stage('Test') {
      steps {
        sh 'docker run --rm python-app-image:latest pytest'
      }
    }

    stage('Deploy') {
      environment {
      
        KUBE_NAMESPACE = 'python-namespace'
      }
      steps {
        
        kubernetesDeploy(
          kubeconfigId: 'arn:aws:eks:us-west-2:020582469906:cluster/demo-eks-cluster',
          configs: '/home/ubuntu/.kube/config',
          kubeNamespace: "${KUBE_NAMESPACE}",
          yamlMergeStrategy: 'merge',
          enableConfigSubstitution: true,
          maxRetries: 5
        )
      }
    }
  }
}
